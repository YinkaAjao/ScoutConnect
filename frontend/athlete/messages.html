<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages | ScoutConnect</title>
    <link rel="shortcut icon" href="./images/sc-logo.png" type="image/png">
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="/frontend/tailwind/tailwind.css">
</head>

<body class="bg-gray-100 dark:bg-dark-main">
    <!-- NAV -->
    <nav
        class="bg-white dark:bg-dark-second h-max md:h-14 w-full shadow flex flex-col md:flex-row items-center justify-center md:justify-between fixed top-0 z-50 border-b dark:border-dark-third">

        <!-- LEFT NAV -->
        <div class="flex items-center justify-between w-full md:w-max px-4 py-2">
            <a href="#" class="mr-2 hidden md:inline-block">
                <img src="./images/sc-logo.png" alt="ScoutConnect logo" class="w-24 sm:w-20 lg:w-10 h-auto">
            </a>
            <a href="#" class="inline-block md:hidden">
                <img src="./images/sc-logo-mb.png" alt="" class="w-32 h-auto">
            </a>
            <div class="flex items-center justify-between space-x-1">
                <div class="relative bg-gray-100 dark:bg-dark-third px-2 py-2 w-10 h-10 sm:w-11 sm:h-11 lg:h-10 lg:w-10 xl:w-max xl:pl-3 xl:pr-8 rounded-full flex items-center justify-center cursor-pointer"
                    onclick="toggleSearchModal()">
                    <i class='bx bx-search-alt-2 text-xl xl:mr-2 dark:text-dark-txt'></i>
                    <input type="text" placeholder="Search messages..."
                        class="outline-none bg-transparent hidden xl:inline-block" id="search-input">
                </div>
                <div
                    class="text-2xl grid place-items-center md:hidden bg-gray-200 dark:bg-dark-third rounded-full w-10 h-10 cursor-pointer hover:bg-gray-300 dark:text-dark-txt">
                    <i class='bx bx-message-rounded'></i>
                </div>
                <div class="text-2xl grid place-items-center md:hidden bg-gray-200 dark:bg-dark-third rounded-full w-10 h-10 cursor-pointer hover:bg-gray-300 dark:text-dark-txt"
                    id="dark-mode-toggle-mb">
                    <i class='bx bxs-moon'></i>
                </div>
            </div>
        </div>
        <!-- END LEFT NAV -->

        <!-- MAIN NAV -->
        <ul class="flex w-full lg:w-max items-center justify-center">
            <li class="w-1/5 md:w-max text-center">
                <a href="athletedashboard.html"
                    class="w-full text-3xl py-2 px-3 xl:px-12 cursor-pointer text-center inline-block rounded text-gray-600 hover:bg-gray-100 dark:hover:bg-dark-third dark:text-dark-txt relative">
                    <i class='bx bxs-home' alt="Home"></i>
                </a>
            </li>
            <li class="w-1/5 md:w-max text-center">
                <a href="achievements.html"
                    class="w-full text-3xl py-2 px-3 xl:px-12 cursor-pointer text-center inline-block rounded text-gray-600 hover:bg-gray-100 dark:hover:bg-dark-third dark:text-dark-txt relative">
                    <i class='bx bx-trophy'></i>
                </a>
            </li>
            <li class="w-1/5 md:w-max text-center">
                <a href="events.html"
                    class="w-full text-3xl py-2 px-3 xl:px-12 cursor-pointer text-center inline-block rounded text-gray-600 hover:bg-gray-100 dark:hover:bg-dark-third dark:text-dark-txt relative">
                    <i class='bx bx-calendar'></i>
                </a>
            </li>
            <li class="w-1/5 md:w-max text-center hidden md:inline-block">
                <a href="videos.html"
                    class="w-full text-3xl py-2 px-3 xl:px-12 cursor-pointer text-center inline-block rounded text-gray-600 hover:bg-gray-100 dark:hover:bg-dark-third dark:text-dark-txt relative">
                    <i class='bx bx-video'></i>
                </a>
            </li>
            <li class="w-1/5 md:w-max text-center inline-block md:hidden">
                <a href="#"
                    class="w-full text-3xl py-2 px-3 xl:px-12 cursor-pointer text-center inline-block rounded text-gray-600 hover:bg-gray-100 dark:hover:bg-dark-third dark:text-dark-txt relative">
                    <i class='bx bx-menu'></i>
                </a>
            </li>
        </ul>
        <!-- END MAIN NAV -->

        <!-- RIGHT NAV -->
        <ul class="hidden md:flex mx-4 items-center justify-center">
            <li>
                <div class="text-xl hidden xl:grid place-items-center bg-gray-200 dark:bg-dark-third dark:text-dark-txt rounded-full mx-1 p-3 cursor-pointer hover:bg-gray-300 relative"
                    onclick="toggleNewMessageModal()">
                    <i class='bx bx-plus'></i>
                </div>
            </li>
            <li>
                <a href="messages.html" class="group relative">
                    <div
                        class="text-3xl py-2 px-3 cursor-pointer text-blue-500 border-b-4 border-blue-500 inline-flex items-center justify-center">
                        <i class='bx bx-message-rounded'></i>
                        <span
                            class="text-xs absolute -top-1 -right-1 bg-red-500 text-white font-semibold rounded-full px-1 text-center min-w-[16px] h-4"
                            id="unread-badge" style="display: none;">0</span>
                    </div>
                </a>
            </li>
            <li>
                <a href="notifications.html" class="group relative">
                    <div
                        class="text-xl grid place-items-center bg-gray-200 dark:bg-dark-third dark:text-dark-txt rounded-full mx-1 p-3 cursor-pointer hover:bg-gray-300 relative">
                        <i class='bx bxs-bell'></i>
                    </div>
                </a>
            </li>
            <li>
                <div class="text-xl grid place-items-center bg-gray-200 dark:bg-dark-third dark:text-dark-txt rounded-full mx-1 p-3 cursor-pointer hover:bg-gray-300 relative"
                    id="dark-mode-toggle">
                    <i class='bx bxs-moon'></i>
                </div>
            </li>
        </ul>
        <!-- END RIGHT NAV -->
    </nav>
    <!-- END NAV -->

    <!-- MAIN -->
    <div class="flex justify-center h-screen">
        <!-- LEFT MENU -->
        <div class="w-1/5 pt-16 h-full hidden xl:flex flex-col fixed top-0 left-0">
            <ul class="p-4">
                <li>
                    <a href="athlete_profile.html"
                        class="flex items-center space-x-2 p-2 hover:bg-gray-200 rounded-lg transition-all dark:text-dark-txt dark:hover:bg-dark-third">
                        <i class='bx bx-user-circle text-2xl'></i>
                        <span class="font-semibold">My Profile</span>
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="flex items-center space-x-2 p-2 hover:bg-gray-200 rounded-lg transition-all dark:text-dark-txt dark:hover:bg-dark-third">
                        <i class='bx bx-group text-2xl'></i>
                        <span class="font-semibold">Connections</span>
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="flex items-center space-x-2 p-2 hover:bg-gray-200 rounded-lg transition-all dark:text-dark-txt dark:hover:bg-dark-third">
                        <i class='bx bx-calendar-event text-2xl'></i>
                        <span class="font-semibold">Events</span>
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="flex items-center space-x-2 p-2 hover:bg-gray-200 rounded-lg transition-all dark:text-dark-txt dark:hover:bg-dark-third">
                        <i class='bx bx-bar-chart-alt-2 text-2xl'></i>
                        <span class="font-semibold">Performance Stats</span>
                    </a>
                </li>
                <li>
                    <a href="video.html"
                        class="flex items-center space-x-2 p-2 hover:bg-gray-200 rounded-lg transition-all dark:text-dark-txt dark:hover:bg-dark-third">
                        <i class='bx bx-video text-2xl'></i>
                        <span class="font-semibold">Training Videos</span>
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="flex items-center space-x-2 p-2 hover:bg-gray-200 rounded-lg transition-all dark:text-dark-txt dark:hover:bg-dark-third">
                        <span class="w-10 h-10 rounded-full grid place-items-center bg-gray-300 dark:bg-dark-second">
                            <i class='bx bx-chevron-down'></i>
                        </span>
                        <span class="font-semibold">See more</span>
                    </a>
                </li>
                <li class="border-b border-gray-200 dark:border-dark-third mt-6"></li>
            </ul>
            <div class="flex justify-between items-center px-4 h-4 group">
                <span class="font-semibold text-gray-500 text-lg dark:text-dark-txt">Recent Conversations</span>
                <span
                    class="text-blue-500 cursor-pointer hover:bg-gray-200 dark:hover:bg-dark-third p-2 rounded-md hidden group-hover:inline-block"
                    onclick="toggleNewMessageModal()">New</span>
            </div>
            <ul class="p-4 overflow-y-auto flex-1" id="sidebar-conversations">
                <!-- Sidebar conversations will be loaded here -->
            </ul>
            <div class="mt-auto p-6 text-sm text-gray-500 dark:text-dark-txt">
                <a href="#">Privacy</a>
                <span>.</span>
                <a href="#">Terms</a>
                <span>.</span>
                <a href="#">Advertising</a>
                <span>.</span>
                <a href="#">Cookies</a>
                <span>.</span>
                <a href="#">Ad choices</a>
                <span>.</span>
                <a href="#">More</a>
                <span>.</span>
                <span>ScoutConnect © 2025</span>
            </div>
        </div>
        <!-- END LEFT MENU -->

        <!-- MAIN CONTENT -->
        <div class="w-full lg:w-2/3 xl:w-2/5 pt-32 lg:pt-16 px-2">
            <!-- MESSAGES HEADER -->
            <div class="px-4 mt-4 shadow rounded-lg bg-white dark:bg-dark-second">
                <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-dark-third">
                    <h2 class="text-xl font-semibold dark:text-dark-txt">Messages</h2>
                    <div class="flex space-x-2">
                        <div class="w-8 h-8 grid place-items-center text-xl hover:bg-gray-200 dark:hover:bg-dark-third rounded-full cursor-pointer dark:text-dark-txt"
                            onclick="toggleSearchModal()">
                            <i class='bx bx-search-alt-2'></i>
                        </div>
                        <div class="w-8 h-8 grid place-items-center text-xl hover:bg-gray-200 dark:hover:bg-dark-third rounded-full cursor-pointer dark:text-dark-txt"
                            onclick="toggleNewMessageModal()">
                            <i class='bx bx-plus'></i>
                        </div>
                        <div
                            class="w-8 h-8 grid place-items-center text-xl hover:bg-gray-200 dark:hover:bg-dark-third rounded-full cursor-pointer dark:text-dark-txt">
                            <i class='bx bx-dots-horizontal-rounded'></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONVERSATION VIEW -->
            <div id="conversation-view" class="mt-4 space-y-2 hidden">
                <!-- Conversation Header -->
                <div class="shadow bg-white dark:bg-dark-second dark:text-dark-txt rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <button onclick="showConversationList()"
                                class="lg:hidden text-gray-500 hover:text-gray-700">
                                <i class='bx bx-arrow-back text-2xl'></i>
                            </button>
                            <img id="conv-user-avatar" src="./images/profile.jpg" alt="Profile picture"
                                class="w-12 h-12 rounded-full">
                            <div>
                                <h3 id="conv-user-name" class="font-semibold">Loading...</h3>
                                <p id="conv-user-status" class="text-sm text-gray-500 dark:text-dark-txt">Loading...</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button
                                class="w-8 h-8 grid place-items-center text-xl hover:bg-gray-200 dark:hover:bg-dark-third rounded-full cursor-pointer dark:text-dark-txt">
                                <i class='bx bx-phone'></i>
                            </button>
                            <button
                                class="w-8 h-8 grid place-items-center text-xl hover:bg-gray-200 dark:hover:bg-dark-third rounded-full cursor-pointer dark:text-dark-txt">
                                <i class='bx bx-video'></i>
                            </button>
                            <button
                                class="w-8 h-8 grid place-items-center text-xl hover:bg-gray-200 dark:hover:bg-dark-third rounded-full cursor-pointer dark:text-dark-txt">
                                <i class='bx bx-info-circle'></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="shadow bg-white dark:bg-dark-second rounded-lg flex flex-col h-96 lg:h-[500px]">
                    <div id="messages-container" class="flex-1 p-4 overflow-y-auto space-y-3">
                        <!-- Messages will be loaded here -->
                    </div>

                    <!-- Message Input -->
                    <div class="border-t border-gray-200 dark:border-dark-third p-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-gray-500 hover:text-gray-700 dark:text-dark-txt">
                                <i class='bx bx-plus text-2xl'></i>
                            </button>
                            <button class="text-gray-500 hover:text-gray-700 dark:text-dark-txt">
                                <i class='bx bx-image text-2xl'></i>
                            </button>
                            <div class="flex-1 relative">
                                <input type="text" id="message-input" placeholder="Type a message..."
                                    class="w-full px-4 py-2 bg-gray-100 dark:bg-dark-third dark:text-dark-txt rounded-full outline-none focus:ring-2 focus:ring-blue-500"
                                    onkeypress="handleMessageKeyPress(event)">
                            </div>
                            <button onclick="sendMessage()"
                                class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors">
                                <i class='bx bx-send text-xl'></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MESSAGE LIST (Default View) -->
            <div id="conversation-list" class="mt-4 space-y-2">
                <!-- Conversations will be loaded here -->
            </div>
        </div>
        <!-- END MAIN CONTENT -->

        <!-- RIGHT MENU -->
        <div class="w-1/5 pt-16 h-full hidden xl:block px-4 fixed top-0 right-0">
            <div class="h-full">
                <div class="flex justify-between items-center px-4 pt-4">
                    <span class="font-semibold text-gray-500 text-lg dark:text-dark-txt">Active Users</span>
                    <span
                        class="text-blue-500 cursor-pointer hover:bg-gray-200 dark:hover:bg-dark-third p-2 rounded-md">See
                        All</span>
                </div>
                <ul class="p-2" id="active-users">
                    <!-- Active users will be loaded here -->
                </ul>
                <div class="border-b border-gray-200 dark:border-dark-third mt-6"></div>

                <div class="flex justify-between items-center px-4 pt-4">
                    <span class="font-semibold text-gray-500 text-lg dark:text-dark-txt">Quick Actions</span>
                </div>
                <ul class="p-2">
                    <li>
                        <button onclick="toggleNewMessageModal()"
                            class="w-full flex items-center space-x-4 p-2 hover:bg-gray-200 dark:hover:bg-dark-third dark:text-dark-txt rounded-lg cursor-pointer text-left">
                            <div class="w-10 h-10 bg-blue-500 text-white rounded-full grid place-items-center">
                                <i class='bx bx-plus'></i>
                            </div>
                            <span class="font-semibold">New Message</span>
                        </button>
                    </li>
                    <li>
                        <button onclick="markAllAsRead()"
                            class="w-full flex items-center space-x-4 p-2 hover:bg-gray-200 dark:hover:bg-dark-third dark:text-dark-txt rounded-lg cursor-pointer text-left">
                            <div class="w-10 h-10 bg-green-500 text-white rounded-full grid place-items-center">
                                <i class='bx bx-check-double'></i>
                            </div>
                            <span class="font-semibold">Mark All Read</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
        <!-- END RIGHT MENU -->
    </div>
    <!-- END MAIN -->

    <!-- New Message Modal -->
    <div id="new-message-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white dark:bg-dark-second rounded-lg p-6 w-11/12 max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold dark:text-dark-txt">New Message</h3>
                <button onclick="toggleNewMessageModal()" class="text-gray-500 hover:text-gray-700">
                    <i class='bx bx-x text-2xl'></i>
                </button>
            </div>

            <div class="mb-4">
                <input type="text" id="user-search-input" placeholder="Search users..."
                    class="w-full px-4 py-2 border border-gray-300 dark:border-dark-third bg-white dark:bg-dark-third dark:text-dark-txt rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                    oninput="searchUsers(this.value)">
            </div>

            <div id="user-search-results" class="max-h-60 overflow-y-auto space-y-2">
                <!-- Search results will appear here -->
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white dark:bg-dark-second rounded-lg p-6 w-11/12 max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold dark:text-dark-txt">Search Conversations</h3>
                <button onclick="toggleSearchModal()" class="text-gray-500 hover:text-gray-700">
                    <i class='bx bx-x text-2xl'></i>
                </button>
            </div>

            <div class="mb-4">
                <input type="text" id="conversation-search-input" placeholder="Search messages..."
                    class="w-full px-4 py-2 border border-gray-300 dark:border-dark-third bg-white dark:bg-dark-third dark:text-dark-txt rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>
    </div>

    <script src="/frontend/script.js"></script>

    <script>
        // Global variables
        let currentUserId = null;
        let currentConversationUserId = null;
        let conversations = [];
        let messages = [];
        let authToken = localStorage.getItem('token');

        document.addEventListener('DOMContentLoaded', async function () {
            try {
                authToken = localStorage.getItem('token');

                // First check if token exists
                if (!authToken) {
                    throw new Error('No token found in localStorage');
                }

                // Then validate it
                const response = await fetch('http://localhost:3000/api/validate-token', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Token validation failed with status: ${response.status}`);
                }

                const payload = JSON.parse(atob(authToken.split('.')[1]));
                currentUserId = payload.id;

                loadConversations();
                loadUnreadCount();
                setInterval(loadUnreadCount, 30000);
            } catch (error) {
                console.error(error);
            }
        });

        // API functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                credentials: 'include' // Important for cookies/sessions
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`http://localhost:3000/api${endpoint}`, options);

                // Handle 401 Unauthorized specifically
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/frontend/login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Load conversations
        async function loadConversations() {
            try {
                conversations = await apiCall('/conversations');
                renderConversations();
            } catch (error) {
                console.error('Failed to load conversations:', error);
            }
        }

        // Render conversations in the list
        function renderConversations() {
            const container = document.getElementById('conversation-list');
            const sidebarContainer = document.getElementById('sidebar-conversations');

            if (conversations.length === 0) {
                container.innerHTML = `
                <div class="text-center py-12">
                    <i class='bx bx-message-rounded text-6xl text-gray-300 dark:text-dark-txt mb-4'></i>
                    <h3 class="text-lg font-semibold text-gray-600 dark:text-dark-txt mb-2">No conversations yet</h3>
                    <p class="text-gray-500 dark:text-dark-txt mb-4">Start a conversation with a scout or athlete</p>
                    <button onclick="toggleNewMessageModal()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                        Start Messaging
                    </button>
                </div>
            `;
                sidebarContainer.innerHTML = '';
                return;
            }

            // Main conversation list
            container.innerHTML = conversations.map(conv => `
            <div class="shadow bg-white dark:bg-dark-second dark:text-dark-txt rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" onclick="openConversation(${conv.userId})">
                <div class="flex items-center space-x-4 p-4">
                    <div class="relative">
                        <img src="${conv.profilePic}" alt="Profile picture" class="w-14 h-14 rounded-full" onerror="this.src='./images/profile.jpg'">
                        ${conv.isOnline ? '<span class="bg-green-500 w-3 h-3 rounded-full absolute right-0 top-3/4 border-white border-2"></span>' : ''}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <h3 class="font-semibold">${conv.name}</h3>
                            <span class="text-xs text-gray-500 dark:text-dark-txt">${conv.lastMessageTime}</span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-dark-txt truncate">${conv.lastMessage || 'No messages yet'}</p>
                        ${conv.sport ? `<span class="text-xs text-blue-500">${conv.sport}</span>` : ''}
                    </div>
                    ${conv.unreadCount > 0 ? `<div class="w-3 h-3 rounded-full bg-blue-500"></div>` : ''}
                </div>
            </div>
        `).join('');

            // Sidebar conversation list (first 4)
            sidebarContainer.innerHTML = conversations.slice(0, 4).map(conv => `
            <li>
                <div class="flex items-center space-x-2 p-2 hover:bg-gray-200 rounded-lg transition-all dark:text-dark-txt dark:hover:bg-dark-third cursor-pointer" onclick="openConversation(${conv.userId})">
                    <img src="${conv.profilePic}" alt="Profile picture" class="w-10 h-10 rounded-lg" onerror="this.src='./images/profile.jpg'">
                    <div class="flex-1 min-w-0">
                        <span class="font-semibold text-sm truncate block">${conv.name}</span>
                        ${conv.unreadCount > 0 ? `<span class="text-xs text-blue-500">${conv.unreadCount} new</span>` : ''}
                    </div>
                </div>
            </li>
        `).join('');
        }

        window.toggleNewMessageModal = function () {
            const modal = document.getElementById('new-message-modal');
            modal.classList.toggle('hidden');
            modal.classList.toggle('flex');
        };


        // Open conversation
        async function openConversation(userId) {
            currentConversationUserId = userId;

            // Hide conversation list and show conversation view
            document.getElementById('conversation-list').classList.add('hidden');
            document.getElementById('conversation-view').classList.remove('hidden');

            try {
                const response = await apiCall(`/conversations/${userId}/messages`);
                messages = response.messages;

                // Update conversation header
                document.getElementById('conv-user-name').textContent = response.otherUser.name;
                document.getElementById('conv-user-status').textContent = response.otherUser.isOnline ? 'Online' : 'Offline';
                document.getElementById('conv-user-avatar').src = response.otherUser.profilePic;

                renderMessages();
                scrollToBottom();
                input.value = '';

                // Refresh conversations to update last message
                loadConversations();

                // Mark messages as read
                await apiCall(`/conversations/${userId}/mark-read`, 'PUT');
                loadUnreadCount();
                loadConversations(); // Refresh to update unread counts

            } catch (error) {
                console.error('Failed to load conversation:', error);
            }
        }

        // Handle Enter key press
        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Scroll to bottom of messages
        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }

        // Toggle new message modal
        window.toggleNewMessageModal = function () {
            const modal = document.getElementById('new-message-modal');
            modal.classList.toggle('hidden');
            modal.classList.toggle('flex');

            if (!modal.classList.contains('hidden')) {
                document.getElementById('user-search-input').focus();
            }
        };

        // Toggle search modal
        window.toggleSearchModal = function () {
            const modal = document.getElementById('search-modal');
            modal.classList.toggle('hidden');
            modal.classList.toggle('flex');

            if (!modal.classList.contains('hidden')) {
                document.getElementById('conversation-search-input').focus();
            }
        };

        // Search users for new conversation
        let searchTimeout;
        async function searchUsers(query) {
            clearTimeout(searchTimeout);

            if (!query.trim()) {
                document.getElementById('user-search-results').innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const users = await apiCall(`/users/search?query=${encodeURIComponent(query)}`);
                    renderSearchResults(users);
                } catch (error) {
                    console.error('Search failed:', error);
                }
            }, 300);
        }

        // Render search results
        function renderSearchResults(users) {
            const container = document.getElementById('user-search-results');

            if (users.length === 0) {
                container.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-gray-500 dark:text-dark-txt">No users found</p>
                </div>
            `;
                return;
            }

            container.innerHTML = users.map(user => `
            <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 dark:hover:bg-dark-third rounded-lg cursor-pointer" onclick="startConversation(${user.id})">
                <img src="${user.profilePic}" alt="Profile picture" class="w-10 h-10 rounded-full" onerror="this.src='./images/profile.jpg'">
                <div class="flex-1">
                    <h4 class="font-semibold dark:text-dark-txt">${user.name}</h4>
                    <p class="text-sm text-gray-500 dark:text-dark-txt">
                        ${user.userType === 'scout' ? user.scoutType || 'Scout' : user.sport || 'Athlete'}
                        ${user.country ? ` • ${user.country}` : ''}
                    </p>
                </div>
                <i class='bx bx-message-rounded text-blue-500'></i>
            </div>
        `).join('');
        }

        // Start new conversation
        async function startConversation(userId) {
            toggleNewMessageModal();

            // Check if conversation already exists
            const existingConv = conversations.find(conv => conv.userId === userId);
            if (existingConv) {
                openConversation(userId);
                return;
            }

            // Open new conversation
            openConversation(userId);
        }

        // Load unread message count
        async function loadUnreadCount() {
            try {
                const response = await apiCall('/messages/unread-count');
                const badge = document.getElementById('unread-badge');

                if (response.unreadCount > 0) {
                    badge.textContent = response.unreadCount;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load unread count:', error);
            }
        }

        // Mark all messages as read
        async function markAllAsRead() {
            try {
                for (const conv of conversations) {
                    if (conv.unreadCount > 0) {
                        await apiCall(`/conversations/${conv.userId}/mark-read`, 'PUT');
                    }
                }
                loadConversations();
                loadUnreadCount();
            } catch (error) {
                console.error('Failed to mark all as read:', error);
            }
        }

        // Load active users for sidebar
        async function loadActiveUsers() {
            // This would typically load from an API endpoint
            // For now, we'll show recent conversation partners
            const activeContainer = document.getElementById('active-users');
            const recentUsers = conversations.slice(0, 4);

            activeContainer.innerHTML = recentUsers.map(user => `
            <li>
                <div class="flex items-center space-x-4 p-2 hover:bg-gray-200 dark:hover:bg-dark-third dark:text-dark-txt rounded-lg cursor-pointer" onclick="openConversation(${user.userId})">
                    <div class="relative">
                        <img src="${user.profilePic}" alt="Profile picture" class="w-12 h-12 rounded-full" onerror="this.src='./images/profile.jpg'">
                        ${user.isOnline ? '<span class="bg-green-500 w-3 h-3 rounded-full absolute right-0 top-3/4 border-white border-2"></span>' : ''}
                    </div>
                    <div>
                        <span class="font-semibold text-sm">${user.name}</span>
                        <p class="text-xs text-gray-500">${user.isOnline ? 'Online now' : 'Offline'}</p>
                    </div>
                </div>
            </li>
        `).join('');
        }

        // Close modals when clicking outside
        window.addEventListener('click', function (event) {
            const newMessageModal = document.getElementById('new-message-modal');
            const searchModal = document.getElementById('search-modal');

            if (event.target === newMessageModal) {
                toggleNewMessageModal();
            }

            if (event.target === searchModal) {
                toggleSearchModal();
            }
        });

        // Show conversation list
        function showConversationList() {
            document.getElementById('conversation-view').classList.add('hidden');
            document.getElementById('conversation-list').classList.remove('hidden');
            currentConversationUserId = null;
        }

        // Render messages
        function renderMessages() {
            const container = document.getElementById('messages-container');

            if (messages.length === 0) {
                container.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-gray-500 dark:text-dark-txt">No messages yet. Start the conversation!</p>
                </div>
            `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isMe = msg.isSentByMe;
                return `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isMe
                        ? 'bg-blue-500 text-white'
                        : 'bg-gray-200 dark:bg-dark-third dark:text-dark-txt'
                    }">
                        <p class="text-sm">${msg.content}</p>
                        <p class="text-xs mt-1 opacity-70">${msg.timestamp}</p>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();

            if (!content || !currentConversationUserId) return;

            try {
                const newMessage = await apiCall(`/conversations/${currentConversationUserId}/messages`, 'POST', {
                    content: content
                });

                messages.push(newMessage);
                renderMessages();
                scrollToBottom();
                input.value = '';

                // Auto-refresh conversations every minute
                setInterval(loadConversations, 60000);

                // Refresh messages if in conversation view
                setInterval(() => {
                    if (currentConversationUserId) {
                        loadConversationMessages();
                    }
                }, 10000);

                async function loadConversationMessages() {
                    if (!currentConversationUserId) return;

                    try {
                        const response = await apiCall(`/conversations/${currentConversationUserId}/messages`);
                        if (response.messages.length !== messages.length) {
                            messages = response.messages;
                            renderMessages();
                            scrollToBottom();
                        }
                    } catch (error) {
                        console.error('Failed to refresh messages:', error);
                    }
                }
            } catch (error) {
                console.error('Failed to send message:', error);
                alert('Failed to send message. Please try again.');
            }
        }
    </script>
</body>

</html>